# 酒店预订系统 - 领域知识与DDD演进实践

## 🏨 业务领域概述

### 核心业务场景
酒店预订系统是一个典型的复杂业务领域，涉及多个业务概念和复杂的定价规则：

1. **酒店产品管理**: 房型、房间、入住规则
2. **价格管理**: 基础价格、动态定价、优惠策略
3. **用户管理**: 会员等级、地域差异、渠道偏好
4. **营销活动**: 节假日定价、限时促销、季节性调整
5. **组合产品**: 酒店+景点的混合产品

### 业务复杂性挑战
- **动态定价**: 价格根据日期、房型、供需关系实时变化
- **多维度策略**: 用户策略、营销策略、渠道策略的组合应用
- **外部系统集成**: 库存系统、支付系统、第三方价格数据
- **业务规则复杂**: 可用性检查、价格计算、用户权限验证
- **演进需求**: 业务需求不断变化，需要灵活的架构支持

## 🎯 核心领域概念

### 1. 聚合根 (Aggregate Root)
- **HotelOffer**: 酒店产品聚合根，管理酒店预订的核心业务规则
- **UserPricingStrategy**: 用户定价策略聚合根，管理基于用户属性的定价
- **MarketingPricingStrategy**: 营销定价策略聚合根，管理基于市场活动的定价

### 2. 实体 (Entity)
- **HotelProduct**: 酒店产品实体，包含房型和房间信息
- **UserLevelDiscount**: 用户等级折扣实体
- **RegionPricing**: 地域定价实体
- **ChannelPricing**: 渠道定价实体

### 3. 值对象 (Value Object)
- **UserContext**: 用户上下文，包含用户等级、地域、渠道信息
- **DateRange**: 日期范围，表示有效期或入住期间
- **PricePair**: 价格对，包含基础价格和优惠价格
- **UserLevel**: 用户等级枚举（青铜、白银、黄金、白金、钻石）
- **Region**: 地域枚举（华北、华南、华东、华西、国际）
- **Channel**: 渠道枚举（官网、移动端、OTA、线下、企业）

### 4. 领域服务 (Domain Service)
- **ComprehensivePricingDomainService**: 综合定价领域服务，协调多个聚合的定价逻辑
- **UserPricingStrategySelector**: 用户策略选择器，管理策略优先级和选择逻辑
- **HotelPricingDomainService**: 酒店定价领域服务，处理基础价格计算

## 🔄 边界上下文与防腐层

### 主要边界上下文
1. **酒店预订上下文** (Hotel Booking Context)
   - 核心业务逻辑
   - 聚合根: HotelOffer, UserPricingStrategy, MarketingPricingStrategy

2. **价格数据上下文** (Price Data Context)
   - 外部价格数据接入
   - 防腐层: PriceDataAdapter

3. **用户管理上下文** (User Management Context)
   - 用户信息和权限管理
   - 值对象: UserContext

### 防腐层设计
```java
// PriceDataAdapter 作为防腐层
public class PriceDataAdapter {
    // 将外部价格数据适配为领域概念
    public static RoomPriceQuery adaptToPriceQuery(
        Map<String, ? extends AbstractPriceData> externalPriceData) {
        return new RoomPriceQuery() {
            @Override
            public BigDecimal queryRoomMinPrice(String roomNo, LocalDate day) {
                // 适配逻辑，将外部数据结构转换为内部业务概念
            }
        };
    }
}
```

## 🌟 核心业务规则

### 1. 价格计算规则
```java
最终价格 = 基础价格 × 价格规则 × 用户策略 × 营销策略
```

### 2. 策略应用顺序
```java
基础价格 → 用户策略定价 → 营销策略定价 → 最终价格
```

### 3. 可用性验证
- 日期可用性检查
- 用户权限验证（等级、地域、渠道）
- 库存可用性验证

### 4. 时效性管理
- 策略有效期控制
- 动态价格更新
- 实时库存同步

## 🎨 业务场景示例

### 场景1: 钻石会员在春节期间通过移动端预订酒店
```
用户: 钻石会员, 华北地区, 移动端渠道
入住日期: 2024年春节期间
房型: 豪华套房

计算过程:
1. 基础价格: 1000元/晚
2. 用户策略: 
   - 钻石会员15%折扣: -150元
   - 移动端额外10%折扣: -85元
   - 用户策略后价格: 765元
3. 营销策略:
   - 春节期间20%加价: +153元
   - 最终价格: 918元
```

### 场景2: 普通用户在618促销期间预订
```
用户: 青铜会员, 华南地区, 官网渠道
入住日期: 618促销期间
房型: 标准间

计算过程:
1. 基础价格: 500元/晚
2. 用户策略: 
   - 青铜会员5%折扣: -25元
   - 用户策略后价格: 475元
3. 营销策略:
   - 618限时15%折扣: -71元
   - 最终价格: 404元
```

## 🔧 技术架构决策

### 1. 聚合设计原则
- **单一责任**: 每个聚合只负责一个业务概念
- **一致性边界**: 聚合内强一致性，聚合间最终一致性
- **封装**: 只暴露业务行为，不暴露内部数据结构

### 2. 防腐层策略
- **适配器模式**: 将外部数据结构适配为领域概念
- **接口隔离**: 定义领域友好的接口，隔离外部系统变化
- **版本演进**: 支持外部系统的版本变化

### 3. 领域服务职责
- **跨聚合协调**: 协调多个聚合根的业务逻辑
- **复杂计算**: 实现复杂的业务计算逻辑
- **策略管理**: 管理策略的选择和应用顺序

## 📈 业务价值与收益

### 1. 业务灵活性
- 支持复杂的定价策略组合
- 快速响应市场变化
- 个性化用户体验

### 2. 系统可维护性
- 清晰的业务概念映射
- 低耦合的架构设计
- 便于测试和调试

### 3. 扩展性
- 易于添加新的策略类型
- 支持新的业务场景
- 平滑的系统演进